<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Báo Cáo Tông Môn</title>
<style>
body {font-family:'Segoe UI',Tahoma,sans-serif;background:#0f172a;color:#fff;padding:20px;}
h1,h2{text-align:center;}
h1{font-size:30px;margin-bottom:5px}
h2{font-size:18px;color:#94a3b8;margin-bottom:20px}
.stats-container{display:flex;gap:15px;margin-bottom:25px;flex-wrap:wrap}
.stat-box{background:#1e293b;padding:15px;border-radius:12px;text-align:center;flex:1;min-width:140px;border:1px solid #334155;box-shadow:0 0 8px #00000050}
.stat-box .number{font-size:24px;font-weight:bold;color:#22c55e}
table{width:100%;border-collapse:collapse;background:#1e293b;border-radius:12px;overflow:hidden;margin-top:20px}
th{background:#334155;padding:12px;text-align:left;cursor:pointer;color:#94a3b8;position:relative}
th:hover{color:#fff;background:#475569}
td{padding:10px;border-top:1px solid #334155}
.avatar{width:35px;height:35px;border-radius:50%;object-fit:cover;border:1px solid #475569}
.green{color:#22c55e;font-weight:bold}
.red{color:#ef4444;font-weight:bold}
.boss-box{background:#1e293b;padding:15px;margin-top:20px;border-radius:12px;border-left:4px solid #38bdf8;box-shadow:0 0 10px #00000050}
.boss-title{font-size:22px;margin-bottom:8px;color:#38bdf8}
.boss-list{margin-top:8px;font-size:14px;max-height:150px;overflow:auto;transition:opacity .35s ease;opacity:1}
.boss-list.fade-out{opacity:0}
th.sorted-asc::after{content:" ▲";color:#38bdf8}
th.sorted-desc::after{content:" ▼";color:#38bdf8}
tr:hover{background:#2d3748}
.debug-id{font-size:10px;color:#64748b;font-family:monospace}
@media(max-width:800px){.stats-container{flex-direction:column}}
</style>
</head>
<body>

<h1 id="guild-name">Đang tải...</h1>
<p id="report-date" style="text-align:center;">Báo cáo hôm nay</p>

<div class="stats-container">
  <div class="stat-box">Tổng Thành Viên<br><span id="total-members" class="number">0</span></div>
  <div class="stat-box">Đã Cống Hiến<br><span id="donated-count" class="number">0</span></div>
  <div class="stat-box">Tổng Vàng Cống<br><span id="total-gold" class="number">0</span></div>
  <div class="stat-box">Tỷ Lệ Hoàn Thành<br><span id="percent" class="number">0%</span></div>
  <div class="stat-box">Người Đánh Boss<br><span id="boss-player-count" class="number">0</span></div>
  <div class="stat-box">Tổng Số Boss Đánh<br><span id="boss-total-count" class="number">0</span></div>
  <div class="stat-box">Tổng Boss Đã Tiêu Diệt<br><span id="boss-hit-count" class="number">0</span></div>
  <div class="stat-box">Ngày Boss Cuối<br><span id="boss-last-date" class="number">Chưa có</span></div>
</div>

<div class="boss-box">
  <div class="boss-title">Báo Cáo Boss Tông Môn</div>
  <div id="boss-list" class="boss-list">Đang tải dữ liệu boss...</div>
</div>

<table>
  <thead>
    <tr>
      <th data-sort="id">ID Game</th>
      <th>Ảnh</th>
      <th data-sort="name">Tên</th>
      <th data-sort="role">Chức Vụ</th>
      <th data-sort="gold">Vàng</th>
      <th data-sort="online">Online Cuối</th>
      <th data-sort="point">Điểm TMC</th>
    </tr>
  </thead>
  <tbody id="guild-table"></tbody>
</table>

<script>
const guild_id = 22;
const roleMap = {1:"Tông chủ",2:"Phó Tông chủ",3:"Trưởng lão",4:"Thành viên"};
let idToName = {}, lastBossSnapshot = {bossInfoStr:"",playersKey:""};
const LOCAL_SORT_KEY="guild_sort_v2";

// Hàm color điểm TMC
function rankColor(point) {
    if (!point) return "#94a3b8";        // gray
    if (point >= 300) return "#ef4444";  // đỏ
    if (point >= 200) return "#eab308";  // vàng
    if (point >= 80) return "#22c55e";   // xanh lá
    if (point > 50) return "#6ebddb";    // xanh dương nhạt
    return "#dba3a3";                     // hồng nhạt <=50
}

const safeParse = v => {try{return typeof v==="string"?JSON.parse(v):v||{}}catch{return{}};}
const parseNum = v => {if(v==null) return null; const n=Number(String(v).trim().replace(/[^\d.-]/g,"")); return Number.isFinite(n)?n:null;}
const toVNTime = s => {if(!s)return""; const d=new Date(s.replace(" ","T")); if(isNaN(d))return s; const p=x=>x.toString().padStart(2,"0"); return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())} - ${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`;}

let currentSort = (()=>{try{return JSON.parse(localStorage.getItem(LOCAL_SORT_KEY))}catch{return{column:"id",asc:true}}})();

const saveSort = ()=>{try{localStorage.setItem(LOCAL_SORT_KEY,JSON.stringify(currentSort))}catch{}};
const applySortIcon = ()=>document.querySelectorAll("th[data-sort]").forEach(th=>{th.classList.remove("sorted-asc","sorted-desc"); if(th.dataset.sort===currentSort.column) th.classList.add(currentSort.asc?"sorted-asc":"sorted-desc");});
const initSortHeader = ()=>document.querySelectorAll("th[data-sort]").forEach(th=>{if(th.__attached)return; th.addEventListener("click",()=>sortTable(th.dataset.sort,true)); th.__attached=true;});

function sortTable(col, toggle=true){
  const tbody = document.getElementById("guild-table");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  if(toggle){if(currentSort.column===col)currentSort.asc=!currentSort.asc; else {currentSort.column=col; currentSort.asc=true;} saveSort();}
  rows.sort((a,b)=>{
    let aRaw=a.dataset[col]||"", bRaw=b.dataset[col]||"";
    if(col==="online"){const at=new Date(aRaw.replace(" ","T")).getTime()||0, bt=new Date(bRaw.replace(" ","T")).getTime()||0; if(at!==bt)return(at-bt)*(currentSort.asc?1:-1);}
    const aN=parseNum(aRaw), bN=parseNum(bRaw); if(aN!==null && bN!==null && aN!==bN) return (aN-bN)*(currentSort.asc?1:-1);
    return (String(aRaw).toLowerCase().localeCompare(String(bRaw).toLowerCase(),"vi"))*(currentSort.asc?1:-1);
  });
  tbody.innerHTML=""; rows.forEach(r=>tbody.appendChild(r));
  applySortIcon();
}

async function fetchJSON(url){const r=await fetch(url); if(!r.ok)throw new Error(`HTTP ${r.status} ${url}`); return await r.json();}
const getGold = (map,m)=>{const g=Number(map[String(m.id_game_character)]); return isNaN(g)?null:g===0?0:g;}

async function loadGuildReport(){
  try{
    const guildRes = await fetchJSON(`https://cmangax10.com/api/get_data_by_id?table=game_guild&data=data,donate&id=${guild_id}`);
    const guild = safeParse(guildRes.data.data);
    const donateMap = safeParse(guildRes.data.donate);

    const membersRes = await fetchJSON(`https://cmangax10.com/api/game_guild_member?waiting=0&guild=${guild_id}`);
    const members = membersRes.data||membersRes;

    const scoreRes = await fetchJSON(`https://cmangax10.com/api/score_list?type=guild_battle_player&limit=500`);
    const scoreMap={}; (scoreRes.data||scoreRes).forEach(s=>{const i=s.info?safeParse(s.info):{}; if(i.id)scoreMap[i.id]=Number(s.score)||0;});

    document.getElementById("guild-name").innerText = guild.name||"Tông Môn";
    document.getElementById("report-date").innerText = `Cập nhật: ${toVNTime(new Date().toISOString())}`;

    const tbody = document.getElementById("guild-table"); tbody.innerHTML="";
    let donated=0, totalGold=0;
    members.forEach(m=>{
      const info=safeParse(m.info), gold=getGold(donateMap,m)||0;
      if(gold>0){donated++; totalGold+=gold;}
      idToName[m.id_user]=info.name||`N/A`;
      const point = scoreMap[m.id_game_character]||0;
      const tr = document.createElement("tr");
      tr.dataset.id=m.id_game_character;
      tr.dataset.name=(info.name||"").toLowerCase();
      tr.dataset.role=m.role||"";
      tr.dataset.gold=gold;
      tr.dataset.online=(m.last_online||"").replace(" ","T");
      tr.dataset.point=point;
      tr.innerHTML=`
        <td class="debug-id">${m.id_game_character}</td>
        <td><img class="avatar" src="https://cmangax10.com/assets/tmp/avatar/${info.avatar||"1.png"}"></td>
        <td><b>${info.name||"N/A"}</b></td>
        <td>${roleMap[m.role]||"Thành viên"}</td>
        <td class="${gold>0?"green":"red"}">${gold>0?gold.toLocaleString():"Chưa Cống"}</td>
        <td style="font-size:12px;color:#94a3b8">${m.last_online||""}</td>
        <td style="color:${rankColor(point)};font-weight:bold">${point}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById("total-members").innerText=members.length;
    document.getElementById("donated-count").innerText=donated;
    document.getElementById("total-gold").innerText=totalGold.toLocaleString();
    document.getElementById("percent").innerText=((donated/members.length)*100).toFixed(1)+"%";

    initSortHeader(); sortTable("gold",false);
    await loadBossReport(guild);

  }catch(e){console.error(e);}
}

async function loadBossReport(guild){
  try{
    const bossObj = guild.boss||{day:"",amount:0};
    document.getElementById("boss-total-count").innerText = bossObj.amount||0;
    document.getElementById("boss-hit-count").innerText = bossObj.amount||0;
    document.getElementById("boss-last-date").innerText = bossObj.day||"Chưa có";

    const chat = await fetchJSON(`https://cmangax10.com/api/chat?last=999999999&channel=guild&channel_id=${guild_id}`).catch(()=>[]);
    const bossMap={};
    chat.forEach(c=>{
      if(!c.text) return;
      const m=/tiêu diệt thành công\s*<span>(.*?)<\/span>/i.exec(c.text); if(!m) return;
      const n=m[1]; if(!bossMap[n]) bossMap[n]={date:c.date, players:new Set()};
      bossMap[n].players.add(idToName[c.id_user]||`ID:${c.id_user}`);
    });

    const infoStr = JSON.stringify(bossObj);
    const playersKey = Object.entries(bossMap).map(([k,v])=>`${k}:${[...v.players].sort().join(",")}`).sort().join("|");
    if(lastBossSnapshot.bossInfoStr===infoStr && lastBossSnapshot.playersKey===playersKey) return;
    lastBossSnapshot={bossInfoStr:infoStr, playersKey};

    const divList=document.getElementById("boss-list"); divList.classList.add("fade-out");
    setTimeout(()=>{
      divList.innerHTML = Object.keys(bossMap).length===0?"Không có dữ liệu boss":
        Object.entries(bossMap).map(([n,d])=>`<div>⚔️ <b>${n}</b> - <span style="color:#22c55e">${[...d.players].join(", ")}</span><small style="float:right;color:#64748b">${d.date}</small></div>`).join("");
      divList.classList.remove("fade-out");
    },200);

    const totalPlayers = new Set(); Object.values(bossMap).forEach(b=>b.players.forEach(p=>totalPlayers.add(p)));
    document.getElementById("boss-player-count").innerText=totalPlayers.size;

  }catch(e){console.error("Lỗi Boss:",e);}
}

loadGuildReport();
</script>
</body>
</html>
