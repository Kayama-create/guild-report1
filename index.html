<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Báo Cáo Tông Môn</title>
<style>
/* ===== UI CƠ BẢN (giữ nguyên giao diện bạn gửi, chỉ thêm 1 vài style mới) ===== */
body { font-family: Arial, sans-serif; background: #0f172a; color: white; padding: 20px; }
h1 { font-size: 30px; margin-bottom: 5px; }
h2 { font-size: 18px; margin-bottom: 20px; color: #94a3b8; }

.stats-container { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
.stat-box { background: #1e293b; padding: 15px 25px; border-radius: 12px; text-align: center; min-width: 160px; box-shadow: 0 0 10px #00000050; }
.stat-box .number { font-size: 24px; font-weight: bold; color: #22c55e; }

table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 12px; overflow: hidden; margin-top: 25px; }
th { background: #334155; padding: 12px 8px; text-align: left; font-weight: bold; cursor: pointer; user-select: none; position: relative; }
td { padding: 10px 8px; border-top: 1px solid #334155; }
.avatar { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }
.green { color: #22c55e; font-weight: bold; }
.red { color: #ef4444; font-weight: bold; }

.boss-box { background: #1e293b; padding: 15px; margin-top: 30px; border-radius: 12px; box-shadow: 0 0 10px #00000050; }
.boss-title { font-size: 22px; margin-bottom: 10px; color: #38bdf8; }
.boss-list div { padding: 6px 0; border-bottom: 1px solid #334155; }
th:nth-child(1), td:nth-child(1) { min-width: 60px; }
th:nth-child(2), td:nth-child(2) { min-width: 70px; text-align: center; }
th:nth-child(3), td:nth-child(3) { min-width: 200px; }
th:nth-child(4), td:nth-child(4) { min-width: 130px; }
th:nth-child(5), td:nth-child(5) { min-width: 120px; text-align: center; }
th:nth-child(6), td:nth-child(6) { min-width: 170px; }
th:nth-child(7), td:nth-child(7) { min-width: 120px; text-align: center; }

/* ===== Sort icons ===== */
th.sorted-asc::after { content: " ▲"; color: #38bdf8; font-size: 12px; margin-left: 6px; }
th.sorted-desc::after { content: " ▼"; color: #38bdf8; font-size: 12px; margin-left: 6px; }

/* ===== Boss fade animation ===== */
.boss-list { transition: opacity .35s ease; opacity: 1; }
.boss-list.fade-out { opacity: 0; }

/* ===== Rank color helper (optional visual) ===== */
.rank-point { font-weight: 700; }

/* optional small responsive tweak */
@media (max-width:800px){
  .stats-container { flex-direction: column; }
}
</style>
</head>
<body>

<center><h1 id="guild-name">Đang tải...</h1></center>
<h2 id="report-date">Báo cáo hôm nay</h2>

<div class="stats-container">
    <div class="stat-box">Tổng Thành Viên<br><span id="total-members" class="number">0</span></div>
    <div class="stat-box">Đã Cống Hiến<br><span id="donated-count" class="number">0</span></div>
    <div class="stat-box">Tổng Vàng Cống<br><span id="total-gold" class="number">0</span></div>
    <div class="stat-box">Tỷ Lệ Hoàn Thành<br><span id="percent" class="number">0%</span></div>
    <div class="stat-box">Người Đánh Boss<br><span id="boss-player-count" class="number">0</span></div>
    <div class="stat-box">Tổng Số Boss Đánh<br><span id="boss-total-count" class="number">0</span></div>
    <div class="stat-box">Tổng Boss Đã Tiêu Diệt<br><span id="boss-hit-count" class="number">0</span></div>
    <div class="stat-box">Ngày Boss Cuối<br><span id="boss-last-date" class="number">Chưa có</span></div>
</div>

<div class="boss-box">
    <div class="boss-title">Báo Cáo Boss Tông Môn</div>
    <div id="boss-list" class="boss-list">Đang tải dữ liệu boss...</div>
</div>

<table>
    <thead>
        <tr>
            <th data-sort="id">ID</th>
            <th>Ảnh</th>
            <th data-sort="name">Tên Nhân Vật</th>
            <th data-sort="role">Vai Trò</th>
            <th data-sort="gold">Vàng Đã Cống</th>
            <th data-sort="online">Online Lần Cuối</th>
            <th data-sort="point">Điểm Tông Môn Chiến</th>
        </tr>
    </thead>
    <tbody id="guild-table"></tbody>
</table>

<script>
/* ================= CONFIG ================= */
const guild_id = 22;
const REFRESH_BOSS_MS = 5000;   // cập nhật boss mỗi 5s
const roleMap = { "1":"Tông chủ","2":"Phó Tông chủ","3":"Trưởng lão","4":"Thành viên" };
const LOCAL_SORT_KEY = "guild_sort_v2";

/* ================= HELPERS ================= */
function safeParseJSON(s, fallback = {}) {
    try { return JSON.parse(s); } catch { return fallback; }
}
function toVietnamTime(str) {
    if (!str) return "";
    const d = new Date(str.replace(" ", "T"));
    if (isNaN(d)) return str;
    const dd = d.getDate().toString().padStart(2,"0");
    const mm = (d.getMonth()+1).toString().padStart(2,"0");
    const yyyy = d.getFullYear();
    const h = d.getHours().toString().padStart(2,"0");
    const m = d.getMinutes().toString().padStart(2,"0");
    const s = d.getSeconds().toString().padStart(2,"0");
    return `${h}:${m}:${s} - ${dd}/${mm}/${yyyy}`;
}
function parseMaybeNumber(v) {
    if (v === null || v === undefined) return null;
    const s = String(v).trim();
    if (s === "") return null;
    const n = Number(s.replace(/[^\d.-]/g,""));
    return Number.isFinite(n) ? n : null;
}
function rankColor(point) {
    if (!point) return "#94a3b8"; // gray
    if (point >= 300) return "#ef4444"; // red
    if (point >= 200) return "#eab308"; // yellow
    if (point >= 80) return "#22c55e"; // green
	if (point <= 50) return "#dba3a3"; // 
	if (point >= 50 || point > 80) return "#6ebddb"; // 
    return "#94a3b8";
}

/* ================= SORT SYSTEM (localStorage + icons + multi-level) ================= */

// load saved sort or default
let currentSort = (function(){
    try {
        const s = localStorage.getItem(LOCAL_SORT_KEY);
        if (s) return JSON.parse(s);
    } catch {}
    return { column: "id", asc: true };
})();

function saveSort() {
    try { localStorage.setItem(LOCAL_SORT_KEY, JSON.stringify(currentSort)); } catch {}
}

function applySortIcon() {
    document.querySelectorAll("th[data-sort]").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
        if (th.dataset.sort === currentSort.column) {
            th.classList.add(currentSort.asc ? "sorted-asc" : "sorted-desc");
        }
    });
}

// sort table rows in-place, multi-level fallback
function sortTable(column, toggleAndSave = true) {
    const tbody = document.getElementById("guild-table");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    if (toggleAndSave) {
        if (currentSort.column === column) currentSort.asc = !currentSort.asc;
        else { currentSort.column = column; currentSort.asc = true; }
        saveSort();
    }

    rows.sort((a, b) => {
        const aRaw = a.dataset[column] ?? "";
        const bRaw = b.dataset[column] ?? "";

        // special-case date (online)
        if (column === "online") {
            const at = new Date((aRaw || "").replace(" ", "T")).getTime() || 0;
            const bt = new Date((bRaw || "").replace(" ", "T")).getTime() || 0;
            if (at !== bt) return (at - bt) * (currentSort.asc ? 1 : -1);
            // fallback to name/id
            const nameCmp = (a.dataset.name || "").localeCompare(b.dataset.name || "", "vi");
            if (nameCmp !== 0) return nameCmp * (currentSort.asc ? 1 : -1);
            return (Number(a.dataset.id || 0) - Number(b.dataset.id || 0)) * (currentSort.asc ? 1 : -1);
        }

        // number?
        const aNum = parseMaybeNumber(aRaw);
        const bNum = parseMaybeNumber(bRaw);
        if (aNum !== null && bNum !== null) {
            if (aNum !== bNum) return (aNum - bNum) * (currentSort.asc ? 1 : -1);
            // fallback to name
            const nameCmp = (a.dataset.name || "").localeCompare(b.dataset.name || "", "vi");
            if (nameCmp !== 0) return nameCmp * (currentSort.asc ? 1 : -1);
            return (Number(a.dataset.id || 0) - Number(b.dataset.id || 0)) * (currentSort.asc ? 1 : -1);
        }

        // text fallback (locale compare for vi)
        const cmp = (String(aRaw).toLowerCase()).localeCompare(String(bRaw).toLowerCase(), "vi");
        if (cmp !== 0) return cmp * (currentSort.asc ? 1 : -1);

        // final fallback by id
        return (Number(a.dataset.id || 0) - Number(b.dataset.id || 0)) * (currentSort.asc ? 1 : -1);
    });

    // reattach
    tbody.innerHTML = "";
    rows.forEach(r => tbody.appendChild(r));
    applySortIcon();
}

/* attach header click once */
function initSortHeader() {
    document.querySelectorAll("th[data-sort]").forEach(th => {
        if (th.__sortAttached) return;
        th.addEventListener("click", () => sortTable(th.dataset.sort, true));
        th.__sortAttached = true;
    });
}

/* ================= DATA LOAD / RENDER ================= */

// We'll load member table once (fast), keep in-memory caches for minimal DOM work
let cachedMembers = [];   // raw member objects
let idToName = {};        // map id_game_character -> name

async function fetchJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
    return await res.json();
}

async function loadGuildReport_once() {
    try {
        // guild info + donate
        const donateUrl = `https://cmangax10.com/api/get_data_by_id?table=game_guild&data=data,donate&id=${guild_id}`;
        const donateData = await fetchJSON(donateUrl);
        const guildInfo = safeParseJSON(donateData.data, {});
        const donate = safeParseJSON(donateData.donate, {});

        // member list (one-time)
        const memberUrl = `https://cmangax10.com/api/game_guild_member?waiting=0&guild=${guild_id}`;
        const memberList = await fetchJSON(memberUrl);
        cachedMembers = memberList; // keep for later if needed

        // score list
        const scoreUrl = `https://cmangax10.com/api/score_list?type=guild_battle_player&limit=500`;
        const scoreList = await fetchJSON(scoreUrl);
        const scoreMap = {};
        scoreList.forEach(s => { if (s.info) { const inf = safeParseJSON(s.info); scoreMap[inf.id] = Number(s.score) || 0; } });

        // render header/title
        document.getElementById("guild-name").innerHTML = `
            <span style="color:brown;font-size:26px;font-weight:600;letter-spacing:1px;">Báo Cáo Tông Môn</span><br><br>
            <span style="color:red;font-size:30px;font-weight:700;text-shadow:0 0 8px rgba(255,157,157,0.5);">${guildInfo.name || ""}</span>
        `;
        const now = new Date();
        document.getElementById("report-date").innerText =
            `Báo cáo hôm nay – ${now.getDate().toString().padStart(2,"0")}/${(now.getMonth()+1).toString().padStart(2,"0")}/${now.getFullYear()}`;

        // fill idToName
        idToName = {};
        memberList.forEach(mem => {
            const info = safeParseJSON(mem.info);
            idToName[mem.id_game_character] = info.name || (`ID:${mem.id_game_character}`);
        });

        // build table rows (one-time)
        const tbody = document.getElementById("guild-table");
        tbody.innerHTML = ""; // start fresh
        let donatedCount = 0, totalGold = 0;
        memberList.forEach(mem => {
            const info = safeParseJSON(mem.info, {});
            const gold = donate[mem.id_game_character] ? Number(donate[mem.id_game_character]) : 0;
            const donated = gold > 0;
            if (donated) { donatedCount++; totalGold += gold; }
            const point = scoreMap[info.id] || 0;

            const tr = document.createElement("tr");
            // store dataset values for sorting
            tr.dataset.id = info.id ?? "";
            tr.dataset.name = (info.name || "").toLowerCase();
            tr.dataset.role = mem.role ?? "";
            tr.dataset.gold = gold ?? "";
            // Save online as ISO-like string (with T) so Date can parse reliably
            const onlineRaw = mem.last_online || "";
            tr.dataset.online = onlineRaw.replace(" ", "T");
            tr.dataset.point = point ?? "";

            // render row cells (use rankColor)
            const pointColor = rankColor(point);
            tr.innerHTML = `
                <td>${info.id ?? ""}</td>
                <td><img class="avatar" src="https://cmangax10.com/assets/tmp/avatar/${info.avatar ?? '1.png'}"></td>
                <td>${info.name ?? ""}</td>
                <td>${roleMap[mem.role] || "Không rõ"}</td>
                <td class="${donated ? 'green' : 'red'}">${donated ? gold : "Chưa cống"}</td>
                <td>${toVietnamTime(mem.last_online)}</td>
                <td class="rank-point" style="color:${pointColor};">${point}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById("total-members").innerText = memberList.length;
        document.getElementById("donated-count").innerText = donatedCount;
        document.getElementById("total-gold").innerText = totalGold.toLocaleString("vi-VN");
        document.getElementById("percent").innerText = ((donatedCount / Math.max(1, memberList.length)) * 100).toFixed(1) + "%";

        // init sort header and apply saved sort
        initSortHeader();
        // ensure saved column exists; if not, fallback to id
        const colExists = !!document.querySelector(`th[data-sort="${currentSort.column}"]`);
        if (!colExists) { currentSort = { column: "id", asc: true }; saveSort(); }
        // apply sort without toggling save
        sortTable(currentSort.column, false);

        // initial boss load (and start interval)
        await loadBossReport_once(guildInfo); // pass guildInfo to avoid re-fetching guild data inside
        setInterval(loadBossReport_once, REFRESH_BOSS_MS);

    } catch (err) {
        console.error("Lỗi loadGuildReport_once:", err);
    }
}

/* ================= BOSS (reload-only) ================= */

// Keep last displayed boss snapshot to avoid needless DOM updates
let lastBossSnapshot = { bossInfoStr: "", playersKey: "" };

async function loadBossReport_once(guildInfoParam) {
    try {
        // get guild info if not passed
        let guildInfo = guildInfoParam;
        if (!guildInfo) {
            const donateUrl = `https://cmangax10.com/api/get_data_by_id?table=game_guild&data=data,donate&id=${guild_id}`;
            const donateData = await fetchJSON(donateUrl);
            guildInfo = safeParseJSON(donateData.data, {});
        }

        // update boss info from guild data
        const bossObj = guildInfo.boss || { day: "", amount: 0 };
        document.getElementById("boss-total-count").innerText = bossObj.amount ?? 0;
        document.getElementById("boss-hit-count").innerText = bossObj.amount ?? 0;
        document.getElementById("boss-last-date").innerText = bossObj.day || "Chưa có";

        // fetch guild chat (guild channel)
        const chatUrl = `https://cmangax10.com/api/chat?last=999999999&channel=guild&channel_id=${guild_id}`;
        let chatData = [];
        try { chatData = await fetchJSON(chatUrl); } catch (e) { console.warn("Không lấy được chat:", e); }

        // parse boss-related messages to extract players per boss name
        // bossMap: bossName -> Set(playerName)
        const bossMap = {};
        chatData.forEach(c => {
            if (!c.text) return;
            // find lines like "Tông Môn ... đã tiêu diệt thành công <span>BossName</span> tại ..."
            const m1 = /đã tiêu diệt thành công\s*<span>(.*?)<\/span>/i.exec(c.text);
            const m2 = /đã tiêu diệt thành công\s*(.*?)\s*tại/i.exec(c.text);
            const bossName = m1?.[1] || m2?.[1] || null;
            if (bossName) {
                const date = c.date || "";
                if (!bossMap[bossName]) bossMap[bossName] = { date: date, players: new Set() };
                // Attempt to find player name in message info or use poster id_user mapped to member name
                // Some chat messages come from System; id_user may be "1". We'll use c.info or id_user mapping.
                let playerName = null;
                if (c.info) {
                    try {
                        const inf = JSON.parse(c.info);
                        if (inf.name) playerName = inf.name;
                    } catch {}
                }
                if (!playerName) playerName = idToName[c.id_user] || `ID:${c.id_user}`;
                bossMap[bossName].players.add(playerName);
            }
        });

        // Build snapshot keys to decide if DOM update needed
        const bossInfoStr = JSON.stringify(bossObj);
        // Create playersKey as a small fingerprint
        const playersKey = Object.entries(bossMap).map(([k,v]) => `${k}:${[...v.players].sort().join(",")}`).sort().join("|");

        if (bossInfoStr === lastBossSnapshot.bossInfoStr && playersKey === lastBossSnapshot.playersKey) {
            // no change -> skip DOM update
            return;
        }

        // update snapshot
        lastBossSnapshot.bossInfoStr = bossInfoStr;
        lastBossSnapshot.playersKey = playersKey;

        // animate fade
        const bossListDiv = document.getElementById("boss-list");
        bossListDiv.classList.add("fade-out");
        setTimeout(() => {
            // clear and render
            bossListDiv.innerHTML = "";
            if (Object.keys(bossMap).length === 0) {
                bossListDiv.innerHTML = "<div>Chưa có bản ghi boss trong chat.</div>";
            } else {
                Object.entries(bossMap).forEach(([bossName, info]) => {
                    const div = document.createElement("div");
                    const playersArr = Array.from(info.players);
                    div.innerHTML = `<b>${bossName}</b> – Ngày: ${info.date} – Người đánh (${playersArr.length}): ${playersArr.join(", ")}`;
                    bossListDiv.appendChild(div);
                });
            }
            bossListDiv.classList.remove("fade-out");
        }, 200);

        // update total unique players across bosses
        const totalPlayersUnique = new Set();
        Object.values(bossMap).forEach(b => b.players.forEach(p => totalPlayersUnique.add(p)));
        document.getElementById("boss-player-count").innerText = totalPlayersUnique.size;

    } catch (err) {
        console.error("Lỗi loadBossReport_once:", err);
    }
}

/* ================= INIT ================= */
loadGuildReport_once();
</script>

</body>
</html>


